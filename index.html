<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>ì—°ë½ì²˜ ê´€ë¦¬ (ëª¨ë°”ì¼)</title>
<style>
:root{--accent:#4456F0;--accent-2:#2f3dcf;--bg:#f4f6f9;--card:#ffffff;--muted:#666;}
html,body{
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;
  overflow-x:hidden;
}
body{background:var(--bg);display:flex;flex-direction:column;min-height:100vh;}
header{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:14px 16px;font-weight:700;font-size:18px;display:flex;align-items:center;justify-content:space-between}
header .title{display:flex;flex-direction:column}
header .subtitle{font-size:12px;opacity:0.95}
.container{padding:12px;flex:1;width:100%;max-width:720px;margin:0 auto;box-sizing:border-box;}
.searchRow{display:flex;gap:8px;margin-bottom:10px;}
.searchRow input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px}
.btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:8px;font-weight:700;cursor:pointer;height:40px;}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
.form{display:flex;gap:8px;margin-bottom:10px}
.form input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd;font-size:15px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.controls input[type=file]{display:none}
.cardList{display:flex;flex-direction:column;gap:10px}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;gap:8px}
.card .info{display:flex;flex-direction:column}
.card .name{font-weight:700;font-size:16px}
.card .phone{color:var(--muted);font-size:14px}
.card .actions{display:flex;gap:6px;align-items:center}
.linkCall{color:var(--accent);text-decoration:none;font-weight:600}
.danger{background:#e74c3c;color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
.small{padding:8px 10px;font-size:14px;height:40px;}
.muted{color:var(--muted);font-size:13px;text-align:center;margin-top:8px}
.row-group{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;}
.row-group .btn,
.row-group label {flex:1;min-width:120px;height:40px;display:flex;align-items:center;justify-content:center;box-sizing:border-box;border-radius:8px;font-weight:700;cursor:pointer;text-align:center;}
.row-group label {background: transparent;color: var(--accent);border:1px solid var(--accent);}
.row-group label input[type=file]{display:none;}
.row-group .small{flex:0 0 auto;}
@media(max-width:600px){
  .form,
  .searchRow,
  .row-group { flex-direction:column; gap:10px; }
  .card{flex-direction:column;align-items:flex-start}
  .card .actions{width:100%;justify-content:space-between}
  .btn { width:100%; font-size:16px; }
  input { font-size:16px; }
}
</style>
</head>
<body>
<header>
  <div class="title">
    <div>Phonebook</div>
    <div class="subtitle">ëª¨ë°”ì¼ìš© ë¡œì»¬ ì—°ë½ì²˜ ê´€ë¦¬ (ì˜¤í”„ë¼ì¸)</div>
  </div>
  <div style="font-size:13px;opacity:0.9">ì•ˆì „: ë¡œì»¬ì €ì¥</div>
</header>

<div class="container">
  <div class="searchRow">
    <input id="search" type="text" placeholder="ê²€ìƒ‰ (ìµœì†Œ 2ì, ì…ë ¥í•œ ëª¨ë“  ë¬¸ì í¬í•¨ì´ì–´ì•¼ í•¨)" />
    <button class="btn ghost small" id="btnReset">ëª¨ë‘ë³´ê¸°</button>
  </div>

  <div class="form">
    <input id="name" type="text" placeholder="ì´ë¦„">
    <input id="phone" type="tel" placeholder="ì „í™”ë²ˆí˜¸">
  </div>

  <div class="row-group">
    <button class="btn" id="btnAdd">ì¶”ê°€</button>
    <button class="btn ghost" id="btnUpdate">ìˆ˜ì •</button>
  </div>

  <div class="row-group">
    <label for="fileInput">CSV ì„ íƒ
      <input id="fileInput" type="file" accept=".csv,text/csv">
    </label>
    <button class="btn" id="btnExportCSV">CSV(out)</button>
  </div>

  <div class="row-group">
    <button class="btn ghost" id="btnChangePw">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    <button class="btn ghost" id="btnResetPw">ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”</button>
  </div>

  <div class="cardList" id="cardList"></div>
  <div class="muted">ì¶”ê°€ ë²ˆí˜¸ëŠ” ì•„ë˜ "ì˜¤ë¥˜&ì¶”ê°€ì˜ê²¬ ë‚¨ê¸°ê¸°"ì— ë‚¨ê¸°ëŠ” ì„¼ìŠ¤</div>
  <div class="muted">ì–´ë–¤ ë²ˆí˜¸ëŠ” ê°€ë” ìš°ë¦¬ì˜ í˜ì´ ë©ë‹ˆë‹¤(ê°œì¸ì •ë³´)</div>
</div>

<script>
const STORAGE_KEY='phonebook_v1',PW_KEY='phonebook_password',DEFAULT_PW='knp123';
let phonebook=[],selectedIndex=null;

const cardList=document.getElementById('cardList');
const nameInput=document.getElementById('name');
const phoneInput=document.getElementById('phone');
const searchInput=document.getElementById('search');
const fileInput=document.getElementById('fileInput');
const btnAdd=document.getElementById('btnAdd');
const btnUpdate=document.getElementById('btnUpdate');
const btnReset=document.getElementById('btnReset');
const btnExportCSV=document.getElementById('btnExportCSV');
const btnChangePw=document.getElementById('btnChangePw');
const btnResetPw=document.getElementById('btnResetPw');

if(!localStorage.getItem(PW_KEY)) localStorage.setItem(PW_KEY,DEFAULT_PW);

function load(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    phonebook = raw ? JSON.parse(raw) : [];
    phonebook = phonebook.filter(p => p && p.name && p.phone);
    save();
  }catch(e){console.error(e); phonebook=[];}
}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(phonebook))}

function render(list=null, forceAll=false){
  const data = list || (forceAll ? phonebook : []);
  cardList.innerHTML='';

  if(!data.length){ 
    cardList.innerHTML='<div class="muted">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ì—°ë½ì²˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>'; 
    return; 
  }

  data.forEach((entry,idx)=>{
    const idxInMain=phonebook.indexOf(entry);
    const card=document.createElement('div');
    card.className='card';

    // âœ… ì „í™”ë²ˆí˜¸ ì—¬ëŸ¬ ê°œ ì§€ì›
    let phoneLinks = '';
    const phones = entry.phone.split('/').map(p => p.trim()).filter(p => p);
    phones.forEach(p => {
      phoneLinks += `<div><a class="linkCall" href="tel:${sanitizeTel(p)}" onclick="event.stopPropagation()">${escapeHtml(p)}</a></div>`;
    });

    card.innerHTML=`
      <div class="info">
        <div class="name">${escapeHtml(entry.name)}</div>
        <div class="phone">${phoneLinks}</div>
      </div>
      <div class="actions">
        <button class="small" onclick="onSelect(${idxInMain}); event.stopPropagation();">ì„ íƒ</button>
        <button class="danger small" onclick="onDelete(${idxInMain}); event.stopPropagation();">ì‚­ì œ</button>
      </div>
    `;
    card.addEventListener('click',()=>onSelect(idxInMain));
    cardList.appendChild(card);
  });
}


function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function sanitizeTel(t){ if(!t) return ''; return String(t).replace(/[^\d\+]/g,''); }

btnAdd.addEventListener('click',()=>{
  const name=nameInput.value.trim(),phone=phoneInput.value.trim();
  if(!name||!phone){alert('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}

  const pw=localStorage.getItem(PW_KEY)||DEFAULT_PW;
  const input=prompt('ì¶”ê°€í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:'); if(input===null)return;
  if(input!==pw){alert('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜. ì¶”ê°€ ì·¨ì†Œ.');return;}

  const exists=phonebook.some(p=>p.name===name&&p.phone===phone);
  if(exists&&!confirm('ë™ì¼í•œ ì—°ë½ì²˜ê°€ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  phonebook.push({name,phone});
  save(); clearForm(); render();
});

function onSelect(index){ selectedIndex=index; const e=phonebook[index]; if(!e)return; nameInput.value=e.name; phoneInput.value=e.phone; }

btnUpdate.addEventListener('click',()=>{
  if(selectedIndex===null){alert('ìˆ˜ì •í•  ì—°ë½ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');return;}
  const name=nameInput.value.trim(),phone=phoneInput.value.trim();
  if(!name||!phone){alert('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');return;}

  const pw=localStorage.getItem(PW_KEY)||DEFAULT_PW;
  const input=prompt('ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:'); if(input===null)return;
  if(input!==pw){alert('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜. ìˆ˜ì • ì·¨ì†Œ.');return;}

  const duplicate=phonebook.some((p,i)=>i!==selectedIndex&&p.name===name&&p.phone===phone);
  if(duplicate){alert('ê°™ì€ ì´ë¦„ê³¼ ë²ˆí˜¸ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ìˆ˜ì • ì·¨ì†Œ.');return;}
  phonebook[selectedIndex]={name,phone};
  save(); clearForm(); selectedIndex=null; render();
});

async function onDelete(index){
  const pw=localStorage.getItem(PW_KEY)||DEFAULT_PW;
  const input=prompt('ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:'); if(input===null)return;
  if(input!==pw){alert('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜. ì‚­ì œ ì·¨ì†Œ.');return;}
  if(!confirm(`"${phonebook[index].name}" ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  phonebook.splice(index,1);
  save();
  if(selectedIndex===index) selectedIndex=null;
  clearForm(); render();
}

function clearForm(){ nameInput.value=''; phoneInput.value=''; }

// === ê²€ìƒ‰ ===
searchInput.addEventListener('input', function () {
  const raw = (this.value || '').trim();
  if (raw.length < 1) { render(); return; }

  const qFull = raw.replace(/\s+/g, '').toLowerCase();
  const tokens = raw.toLowerCase().split(/\s+/).filter(t => t.length > 0);
  const charTokens = [...qFull];
  const queryNumMap = {};
  for (const ch of qFull) { if (/\d/.test(ch)) queryNumMap[ch] = (queryNumMap[ch] || 0) + 1; }

  const results = phonebook.filter(e => {
    const nameNorm = (e.name || '').toLowerCase().replace(/\s+/g, '');
    if (nameNorm.includes(qFull)) return true;
    if (tokens.every(token => nameNorm.includes(token))) return true;
    if (charTokens.every(ch => nameNorm.includes(ch))) {
      for (const [num, count] of Object.entries(queryNumMap)) {
        const targetCount = (nameNorm.match(new RegExp(num, 'g')) || []).length;
        if (targetCount < count) return false;
      }
      return true;
    }
    return false;
  });

  render(results);
});

let showAll = false; // ì „ì²´ë³´ê¸° í† ê¸€ ìƒíƒœ

btnReset.addEventListener('click', ()=>{
  showAll = !showAll; // ìƒíƒœ ë°˜ì „
  if(showAll){
    render(phonebook, true); // ì „ì²´ í‘œì‹œ
    btnReset.textContent = 'ë³´ê¸° ìˆ¨ê¸°ê¸°'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
  } else {
    render([], true); // ì „ì²´ ì´ˆê¸°í™” (ë¹ˆ í™”ë©´)
    btnReset.textContent = 'ëª¨ë‘ë³´ê¸°';
  }
});

// === CSV ê¸°ëŠ¥ ===
fileInput.addEventListener('change',async(ev)=>{
  const file=ev.target.files[0]; if(!file)return;
  try{ const text=await readFileWithAutoEncoding(file); importCSVText(text); }
  catch(err){console.error(err); alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜'); }
  finally{ fileInput.value=''; }
});

async function readFileWithAutoEncoding(file){
  const ab=await file.arrayBuffer(); let t;
  try{t=new TextDecoder('utf-8',{fatal:false}).decode(ab);}catch(e){t=new TextDecoder('utf-8').decode(ab);}
  if((t.match(/\uFFFD/g)||[]).length>Math.max(1,Math.floor(t.length*0.01))){ try{t=new TextDecoder('euc-kr').decode(ab);}catch(e){console.warn('euc-kr decode failed',e);} }
  return t;
}

function importCSVText(text, options = {}){
  const lines=text.replace(/\r/g,'').split('\n').map(l => l.trim()).filter(l => l !== '');
  if(!lines.length){ alert('ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤.'); return; }

  let start=0;
  if(lines[0].includes('ì´ë¦„') && lines[0].includes('ì „í™”ë²ˆí˜¸')) start=1;

  let added=0;
  for(let i=start;i<lines.length;i++){
    const parsed=parseCSVLine(lines[i]);
    if(!parsed || parsed.length < 2) continue;
    const name=parsed[0].trim(), phone=parsed[1].trim();
    if(!name || !phone) continue;

    // âœ… ì¤‘ë³µ ì œê±°: ì´ë¦„ê³¼ ë²ˆí˜¸ ë‘˜ ë‹¤ ê°™ìœ¼ë©´ ì¶”ê°€ ì•ˆ í•¨
    if(!phonebook.some(p => p.name.trim() === name && p.phone.trim() === phone)){
      phonebook.push({name, phone});
      added++;
    }
  }
  save(); render();
  if(added > 0 && !options.silent){
  alert(`${added}ê°œì˜ ìƒˆ ì—°ë½ì²˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function parseCSVLine(line){
  const res=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; continue; }
    if((ch===',' || ch==='\t') && !inQ){ res.push(cur); cur=''; continue; }
    cur+=ch;
  }
  res.push(cur); return res;
}

btnExportCSV.addEventListener('click',()=>{
  if(!phonebook.length){alert('ë‚´ë³´ë‚¼ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.'); return;}
  let csv='Name,Telephone\n';
  phonebook.forEach(p=>{ csv+=`${csvSafe(p.name)},${csvSafe(p.phone)}\n`; });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='phonebook.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

btnChangePw.addEventListener('click',()=>{
  const current=localStorage.getItem(PW_KEY)||DEFAULT_PW;
  const curInput=prompt('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:'); if(curInput===null)return;
  if(curInput!==current){alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');return;}
  const newPw=prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ê³µë°± ë¶ˆê°€):'); if(newPw===null)return;
  if(!newPw||newPw.trim().length===0){alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.'); return;}
  localStorage.setItem(PW_KEY,newPw); alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
});

btnResetPw.addEventListener('click',()=>{
  if(!confirm(`ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ë©´ "${DEFAULT_PW}"(ìœ¼)ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  localStorage.setItem(PW_KEY,DEFAULT_PW); alert(`ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (${DEFAULT_PW})`);
});

function csvSafe(s){ if(s==null) return ''; const str=String(s); if(str.includes(',')||str.includes('"')||str.includes('\n')) return '"'+str.replace(/"/g,'""')+'"'; return str; }

// === data.csv ìë™ ë¶ˆëŸ¬ì˜¤ê¸° (ë°°í¬ìš©) ===
async function loadDefaultCSV(){
  try{
    const res = await fetch('data.csv', { cache: 'no-store' });
    if(!res.ok) return;

    const text = await res.text();

    // ğŸ”¥ ê¸°ì¡´ localStorage ë°ì´í„° ì™„ì „ ì œê±°
    phonebook = [];
    save();

    // ğŸ”¥ data.csv ë‚´ìš©ë§Œ ë‹¤ì‹œ ë¡œë“œ
    importCSVText(text);

  }catch(e){
    console.warn('data.csv ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', e);
  }
}

load(); 
render(); // forceAll=false â†’ ì´ˆê¸° í™”ë©´ ë¹„ì–´ìˆìŒ
loadDefaultCSV();

window.onSelect=onSelect; window.onDelete=onDelete;
</script>

<!-- ì—¬ê¸°ì— ì£¼ê°€ ì „í™”ë²ˆí˜¸ ë‚¨ê¸°ê¸° ë²„íŠ¼ ì‚½ì… -->
<div style="text-align: center;">
  <button 
    id="feedback-btn"
    style="padding:12px 20px; font-size:16px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;"
    onclick="window.open('https://tally.so/r/dWElLr', '_blank');"
  >
    ì¶”ê°€ ì „í™”ë²ˆí˜¸ ë‚¨ê¸°ê¸°
  </button>
</div>
  
</body>
</html>
